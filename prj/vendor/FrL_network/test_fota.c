/**************************************************************************
 *    (C)2025 Freelux
 *
 *File 				: test_fota.c
 *Created on		: Oct 14, 2025
 *Author			: Freelux RnD Team
 *Description		:
 *License: Revised BSD License, see LICENSE.TXT file include in the project
 **************************************************************************/

#include "tl_common.h"
#include "fl_wifi2ble_fota.h"
/******************************************************************************/
/******************************************************************************/
/***                                Global Parameters                        **/
/******************************************************************************/
/******************************************************************************/



/******************************************************************************/
/******************************************************************************/
/***                           Private definitions                           **/
/******************************************************************************/
/******************************************************************************/
u32 VIRTUAL_FW_SIZE =0;

/******************************************************************************/
/******************************************************************************/
/***                       Functions declare                   		         **/
/******************************************************************************/
/******************************************************************************/
int _send_fw(void){
	static u32 bin_test=0;
	static u32 count=0;
	u8 fota_cmd_test[40];
	memset(fota_cmd_test,0,sizeof(fota_cmd_test));
//	fota_cmd_test[0] = U16_LO(bin_test);
//	fota_cmd_test[1] = U16_HI(bin_test);
	fota_cmd_test[0] = U16_LO(count);
	fota_cmd_test[1] = U16_HI(count);
	memset(fota_cmd_test+2,(u8)bin_test,27);
	if (bin_test >= VIRTUAL_FW_SIZE) {
		ERR(APP,"TEST FOTA (%d bytes)=> END %d\r\n",VIRTUAL_FW_SIZE,bin_test);
		bin_test=0;
		count=0;
		return -1;
	}
	count++;
	if(bin_test + 27 > VIRTUAL_FW_SIZE){
		bin_test = VIRTUAL_FW_SIZE-bin_test;
		memset(fota_cmd_test,0,sizeof(fota_cmd_test));
		fota_cmd_test[0] = U16_LO(count);
		fota_cmd_test[1] = U16_HI(count);
		memset(fota_cmd_test+2,(u8)bin_test,27);
	}
	else
	{
		bin_test+=27;
	}
	fl_wifi2ble_fota_push(fota_cmd_test,29);
	return 0;
}

/******************************************************************************/
/******************************************************************************/
/***                            Functions callback                           **/
/******************************************************************************/
/******************************************************************************/

void TEST_virtual_fw(u32 _fwsize) {
	if (blt_soft_timer_find(_send_fw) == -1) {
		ERR(APP,"TEST FOTA (%d bytes)!!!\r\n",_fwsize);
		VIRTUAL_FW_SIZE = _fwsize;
		blt_soft_timer_add(&_send_fw,50 * 1003);
	}
}

/******************************************************************************/
/******************************************************************************/
/***                      Processing functions 					             **/
/******************************************************************************/
/******************************************************************************/
